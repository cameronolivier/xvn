# Milestone 7: Interactive Setup Wizard - Specification

## Overview

Transform the basic `xvn setup` command into an interactive, educational wizard that guides users through initial configuration. This milestone focuses on improving the first-time user experience by making configuration more discoverable, understandable, and user-friendly.

## Goals

1. **Improve First-Time User Experience**: Guide users through setup with clear explanations
2. **Discoverability**: Help users learn about all available configuration options
3. **Validation**: Ensure configuration is valid before saving
4. **Flexibility**: Support both interactive and non-interactive modes
5. **Maintainability**: Allow users to modify configuration by re-running wizard

## Command Structure

### Primary Command
```bash
xvn init [OPTIONS]
```

### Aliases
- `xvn setup` - Maintained for backward compatibility

### Options
- `--quick` - Skip wizard, use sensible defaults
- `--force` - Overwrite existing configuration
- `--shell <SHELL>` - Specify shell instead of auto-detect
- `--non-interactive` - Run without prompts (CI/automation)

## User Flow

### 5-Step Wizard

#### Step 1: Shell Detection
- Auto-detect user's shell from `$SHELL` environment variable
- Display detected shell and ask for confirmation
- Allow manual selection if auto-detect is wrong
- Supported shells: bash, zsh
- Show shell profile path that will be modified

#### Step 2: Version Manager Detection & Selection
- Scan for installed version managers:
  - **nvm**: Check `~/.nvm/nvm.sh`, `$NVM_DIR`
  - **fnm**: Check `which fnm`, `~/.fnm`
  - **n**: Check `which n`, `/usr/local/n`
- Present multi-select checklist of detected managers
- Allow users to specify priority order
- Warn if no version managers detected
- Provide installation links for popular managers

#### Step 3: Auto-Install Behavior
- Present 3 options:
  1. **Prompt** (recommended): Ask before installing each version
  2. **Always**: Automatically install missing versions
  3. **Never**: Show error, don't install
- Explain implications of each choice
- Default to "Prompt" for safety

#### Step 4: Version File Preferences
- Present multi-select checklist:
  - `.nvmrc` (standard Node.js convention)
  - `.node-version` (alternative format)
  - `.tool-versions` (asdf compatibility)
- Allow specifying priority order
- Default: `.nvmrc`, `.node-version`

#### Step 5: Configuration Review
- Display summary of all choices:
  - Shell and profile path
  - Plugin priority order
  - Auto-install mode
  - Version file priority
  - Config file location
- Ask for final confirmation
- Allow going back to modify

### Post-Configuration Actions
1. Write configuration to `~/.xvnrc`
2. Install shell integration (copy `xvn.sh`, modify profile)
3. Display success message with:
   - Config file location
   - Shell profile modified
   - Next steps to activate
   - How to re-run wizard

## Configuration Format

Generated `~/.xvnrc`:
```yaml
# xvn configuration file
# Generated by: xvn init
# Last modified: 2025-10-02 18:30:00
#
# To modify this configuration, run: xvn init

# Shell integration
# Auto-detected: zsh
shell: zsh

# Version manager priority order
# Available: nvm, fnm, n, asdf, volta
plugins:
  - nvm
  - fnm

# Auto-install behavior when version not found
# Options: prompt (ask each time), always (install automatically), never (error)
auto_install: prompt

# Version files to search for (in priority order)
version_files:
  - .nvmrc
  - .node-version
```

## Technical Architecture

### Module Structure

```
src/
├── cli.rs                    # Add Init command
├── init/
│   ├── mod.rs               # Public API
│   ├── wizard.rs            # Interactive wizard logic
│   ├── prompts.rs           # Individual prompt functions
│   ├── detection.rs         # Auto-detection logic
│   ├── validation.rs        # Config validation
│   └── installer.rs         # Reuse setup::SetupInstaller
└── setup/                   # Existing setup code (reused)
    ├── installer.rs
    ├── shell_detection.rs
    └── profile_modification.rs
```

### Key Components

#### 1. Wizard Orchestrator (`init/wizard.rs`)
- Coordinates the 5-step flow
- Handles state between steps
- Manages "back" navigation
- Non-interactive mode fallback

#### 2. Prompt Functions (`init/prompts.rs`)
- `prompt_shell()` - Shell selection with confirmation
- `prompt_plugins()` - Multi-select version managers
- `prompt_auto_install()` - Choose auto-install mode
- `prompt_version_files()` - Multi-select version files
- `prompt_confirm_config()` - Review and confirm

#### 3. Detection Logic (`init/detection.rs`)
- `detect_shell()` - Auto-detect from `$SHELL`
- `detect_version_managers()` - Scan for installed managers
- `check_nvm()`, `check_fnm()`, etc. - Individual detectors

#### 4. Validation (`init/validation.rs`)
- `validate_config()` - Ensure config is valid
- `validate_shell()` - Shell is supported
- `validate_plugins()` - At least one plugin selected

### Interactive Prompts Library

Use `inquire` crate for better UX:
- `inquire::Confirm` - Yes/no questions
- `inquire::Select` - Single selection
- `inquire::MultiSelect` - Multiple selection with checkboxes
- `inquire::Text` - Free-form input (if needed)

### Non-Interactive Mode

When `stdin` is not a TTY or `--non-interactive` flag:
1. Use sensible defaults for all options
2. Auto-detect what's possible
3. Skip confirmation prompts
4. Log decisions to stdout

## Error Handling

### Graceful Failures
- **No TTY**: Fall back to non-interactive mode
- **No version managers**: Warn but allow setup (can install later)
- **Invalid input**: Re-prompt with helpful error message
- **Config write failure**: Show error, don't modify shell profile

### User-Friendly Errors
- Show what went wrong
- Explain why it matters
- Suggest next steps
- Provide links to documentation

## Testing Strategy

### Unit Tests
- Test each prompt function individually
- Test detection logic with mocked filesystem
- Test validation logic with various configs
- Test config serialization/deserialization

### Integration Tests
- Test full wizard flow with simulated input
- Test `--quick` mode
- Test `--non-interactive` mode
- Test re-running wizard to modify config

### Manual Testing Checklist
- [ ] Run wizard on clean system (no existing config)
- [ ] Run wizard with existing config (modify mode)
- [ ] Test with nvm installed
- [ ] Test with fnm installed
- [ ] Test with no version managers
- [ ] Test `--quick` flag
- [ ] Test `--force` flag
- [ ] Test in non-TTY environment (CI)
- [ ] Verify generated config works with xvn

## Success Criteria

- [ ] Wizard completes successfully on first run
- [ ] Generated config is valid YAML
- [ ] Shell integration works after wizard
- [ ] Config file location is clearly communicated
- [ ] Wizard can be re-run to modify configuration
- [ ] Non-interactive mode works for automation
- [ ] `--quick` flag completes in <5 seconds
- [ ] Educational prompts are clear and helpful
- [ ] Error messages provide actionable guidance

## Future Enhancements (Out of Scope)

- Themes/color schemes configuration
- Advanced plugin configuration (custom paths)
- Export/import configuration
- Configuration validation command (`xvn config validate`)
- Interactive plugin installation from wizard
